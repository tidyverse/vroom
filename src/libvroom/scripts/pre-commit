#!/bin/bash
# Pre-commit hook to run clang-format on staged C/C++ files
# Install: ln -sf ../../scripts/pre-commit .git/hooks/pre-commit

set -e

# Check if clang-format is available
if ! command -v clang-format &> /dev/null; then
    echo "Warning: clang-format not found, skipping format check"
    exit 0
fi

# Get list of staged C/C++ files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(c|cpp|h|hpp)$' || true)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

# Format each file and re-stage if changed
REFORMATTED=()
while IFS= read -r file; do
    if [ -f "$file" ]; then
        # Get the original content
        ORIGINAL=$(cat "$file")

        # Format in place
        clang-format -i "$file"

        # Check if file changed
        if [ "$ORIGINAL" != "$(cat "$file")" ]; then
            REFORMATTED+=("$file")
            git add "$file"
        fi
    fi
done <<< "$STAGED_FILES"

# Report what was reformatted
if [ ${#REFORMATTED[@]} -gt 0 ]; then
    echo "clang-format: reformatted ${#REFORMATTED[@]} file(s):"
    for file in "${REFORMATTED[@]}"; do
        echo "  $file"
    done
fi

exit 0
