name: Python Wheels

# Build wheels on main (fast builds) and releases (full builds)
# PRs are tested by python.yml workflow - no wheel builds needed
on:
  push:
    branches: [main]
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build_wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # Windows disabled until POSIX compatibility work is done (sys/mman.h, __builtin_* intrinsics)
        os: [ubuntu-latest, macos-14]

    steps:
      - uses: actions/checkout@v4
        with:
          # History and tags needed for setuptools_scm to compute version
          # based on distance from the last tag (e.g., v0.0.1 -> 0.0.2.dev18)
          # Using 100 commits buffer instead of full history (0) for efficiency
          fetch-depth: 100
          fetch-tags: true

      # Only set up QEMU for release builds (slow emulation)
      - name: Set up QEMU (Linux ARM64)
        if: runner.os == 'Linux' && startsWith(github.ref, 'refs/tags/v')
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.22
        with:
          package-dir: python
          output-dir: wheelhouse
        env:
          # Build for Python 3.9-3.12
          CIBW_BUILD: cp39-* cp310-* cp311-* cp312-*
          # Skip 32-bit builds and musllinux
          CIBW_SKIP: "*-win32 *-manylinux_i686 *-musllinux*"
          # Linux: x86_64 only on main (fast), add aarch64 on releases (slow QEMU)
          CIBW_ARCHS_LINUX: ${{ startsWith(github.ref, 'refs/tags/v') && 'x86_64 aarch64' || 'x86_64' }}
          # Build only ARM on macOS (x86_64 cross-compile has clang segfaults)
          CIBW_ARCHS_MACOS: arm64
          # Build x64 on Windows (ARM64 support requires additional work)
          CIBW_ARCHS_WINDOWS: AMD64
          # macOS ARM64: require 14.0+ (Homebrew libs are built for 14.0+)
          # CMAKE_BUILD_PARALLEL_LEVEL=2 to avoid memory issues causing clang segfaults
          CIBW_ENVIRONMENT_MACOS: "MACOSX_DEPLOYMENT_TARGET=14.0 LIBRARY_PATH=/opt/homebrew/lib:/usr/local/lib CPATH=/opt/homebrew/include:/usr/local/include CMAKE_PREFIX_PATH=/opt/homebrew:/usr/local CMAKE_BUILD_PARALLEL_LEVEL=2"
          # macOS: Install compression libraries via Homebrew
          CIBW_BEFORE_BUILD_MACOS: brew install zstd lz4 snappy || true
          # Linux: Install compression development libraries (manylinux2014 uses yum)
          CIBW_BEFORE_BUILD_LINUX: yum install -y zlib-devel libzstd-devel lz4-devel snappy-devel || true
          # Windows: Install zlib and compression libraries via vcpkg
          CIBW_BEFORE_BUILD_WINDOWS: >
            pip install delvewheel &&
            vcpkg install zlib:x64-windows zstd:x64-windows lz4:x64-windows snappy:x64-windows
          CIBW_ENVIRONMENT_WINDOWS: CMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake
          CIBW_REPAIR_WHEEL_COMMAND_WINDOWS: delvewheel repair -w {dest_dir} {wheel}
          # Skip wheel tests for now - test suite has API mismatches (uses 'delimiter' but binding uses 'separator')
          # TODO: Fix test suite to match the actual Python bindings API
          CIBW_TEST_SKIP: "*"
          # Repair wheels to bundle dependencies
          CIBW_REPAIR_WHEEL_COMMAND_LINUX: auditwheel repair -w {dest_dir} {wheel}
          CIBW_REPAIR_WHEEL_COMMAND_MACOS: delocate-wheel -w {dest_dir} -v {wheel}

      - uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: ./wheelhouse/*.whl

  build_sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # History and tags needed for setuptools_scm to compute version
          # based on distance from the last tag (e.g., v0.0.1 -> 0.0.2.dev18)
          # Using 100 commits buffer instead of full history (0) for efficiency
          fetch-depth: 100
          fetch-tags: true

      - name: Build sdist
        run: |
          cd python
          pip install build
          python -m build --sdist

      - uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: python/dist/*.tar.gz

  publish:
    name: Publish to PyPI
    needs: [build_wheels, build_sdist]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    environment:
      name: pypi
      url: https://pypi.org/p/vroom-csv
    permissions:
      id-token: write

    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true

      - uses: actions/download-artifact@v4
        with:
          name: sdist
          path: dist

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

  publish-testpypi:
    name: Publish to TestPyPI
    needs: [build_wheels, build_sdist]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: testpypi
      url: https://test.pypi.org/p/vroom-csv
    permissions:
      id-token: write

    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true

      - uses: actions/download-artifact@v4
        with:
          name: sdist
          path: dist

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/

