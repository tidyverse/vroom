name: Performance Regression Check

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  pull-requests: write

jobs:
  benchmark:
    name: Performance Regression Detection
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential ccache

    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: ~/.cache/ccache
        key: ccache-perf-${{ runner.os }}-${{ github.sha }}
        restore-keys: |
          ccache-perf-${{ runner.os }}-

    - name: Configure ccache
      run: |
        ccache --set-config=max_size=500M
        ccache --set-config=compression=true
        ccache -z

    - name: Configure CMake (Release)
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build benchmark
      run: |
        cmake --build build --target libvroom_benchmark --config Release

    - name: Show ccache stats
      run: |
        ccache -s

    - name: Run quick benchmark
      timeout-minutes: 5
      run: |
        # Run benchmarks from parser_overhead_benchmarks.cpp which use generated data
        # (500K rows x 10 cols, ~32MB) - larger size for stable timing (see issue #508)
        #
        # Selected benchmarks:
        # - BM_RawFirstPass: Raw SIMD scanning performance
        # - BM_ParserWithExplicitDialect: Full parser overhead
        # - BM_ParserMultiThread/1: Single-threaded parser
        # - BM_ParserMultiThread/4: Multi-threaded parser
        ./build/libvroom_benchmark \
          --benchmark_filter="BM_RawFirstPass|BM_ParserWithExplicitDialect|BM_ParserMultiThread/1$|BM_ParserMultiThread/4$" \
          --benchmark_repetitions=3 \
          --benchmark_min_time=0.5s \
          --benchmark_out=build/benchmark_results.json \
          --benchmark_out_format=json

    - name: Download previous benchmark results
      uses: actions/cache/restore@v4
      id: cache-benchmark
      with:
        path: baseline_benchmark.json
        key: benchmark-baseline-${{ runner.os }}-main
        restore-keys: |
          benchmark-baseline-${{ runner.os }}-main

    - name: Compare benchmarks and detect regression
      id: compare
      run: python3 benchmark/check_regression.py

    - name: Save baseline for future runs
      uses: actions/cache/save@v4
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      with:
        path: baseline_benchmark.json
        key: benchmark-baseline-${{ runner.os }}-main

    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: benchmark-results
        path: |
          build/benchmark_results.json
          baseline_benchmark.json
        retention-days: 30
