name: Sanitizers

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Manual trigger

# Known test issues causing sanitizer failures (library code itself is clean):
#
# 1. ASAN buffer reads: Some tests use string buffers without proper SIMD padding.
#    The parser's SIMD code reads 64 bytes at a time, requiring LIBVROOM_PADDING
#    (64 bytes) of readable memory beyond the data. Tests using makeBuffer()
#    correctly add padding, but ASAN may still flag reads as the padding bytes
#    were copied from a smaller source allocation.
#
# 2. Memory leaks: Test code often doesn't free get_corpus() return buffers.
#    Leak detection is disabled via ASAN_OPTIONS=detect_leaks=0.
#
# See: https://github.com/jimhester/libvroom/issues/310

jobs:
  asan-ubsan:
    name: ASAN + UBSAN
    runs-on: ubuntu-latest
    # Known test issues cause failures - see comment at top
    continue-on-error: true

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential

    - name: Cache FetchContent dependencies
      uses: actions/cache@v4
      with:
        path: build/_deps
        key: deps-Linux-Debug-${{ hashFiles('CMakeLists.txt') }}
        restore-keys: |
          deps-Linux-Debug-

    - name: Configure with ASAN and UBSAN
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Debug -DENABLE_ASAN=ON -DENABLE_UBSAN=ON

    - name: Build
      run: |
        cmake --build build -j

    - name: Run tests with ASAN and UBSAN (leak detection disabled)
      env:
        # Disable leak detection as many tests don't free get_corpus() buffers
        # This is a test issue, not library issue - library code passes ASAN checks
        ASAN_OPTIONS: detect_leaks=0:abort_on_error=1:halt_on_error=1
        UBSAN_OPTIONS: print_stacktrace=1:halt_on_error=1
      run: |
        cd build && ctest --output-on-failure -j

  tsan:
    name: ThreadSanitizer
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential

    - name: Cache FetchContent dependencies
      uses: actions/cache@v4
      with:
        path: build/_deps
        key: deps-Linux-Debug-${{ hashFiles('CMakeLists.txt') }}
        restore-keys: |
          deps-Linux-Debug-

    - name: Configure with TSAN
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Debug -DENABLE_TSAN=ON

    - name: Build
      run: |
        cmake --build build -j

    - name: Run concurrency tests with TSAN
      env:
        TSAN_OPTIONS: halt_on_error=1:second_deadlock_stack=1:suppressions=${{ github.workspace }}/tsan_suppressions.txt
      run: |
        cd build && ctest -R concurrency --output-on-failure -j

    - name: Run all tests with TSAN
      env:
        TSAN_OPTIONS: halt_on_error=1:second_deadlock_stack=1:suppressions=${{ github.workspace }}/tsan_suppressions.txt
      run: |
        cd build && ctest --output-on-failure -j
